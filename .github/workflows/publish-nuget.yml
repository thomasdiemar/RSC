name: Publish NuGet Packages

on:
  push:
    branches:
      - main
      - fraction
    tags:
      - 'v*'

jobs:
  build-test-publish:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
    
    - name: Restore dependencies
      env:
        AZURE_DEVOPS_NUGET_TOKEN: ${{ secrets.AZURE_DEVOPS_NUGET_TOKEN }}
      run: |
        # Configure NuGet authentication before restoring
        # Remove existing source to avoid conflicts
        dotnet nuget remove source SpaceEngineers 2>$null || $null
        
        # Add the Azure DevOps feed with explicit authentication
        dotnet nuget add source `
          https://diemar.pkgs.visualstudio.com/06ec9d7b-fe8e-4f72-a28e-3edb09ab1b81/_packaging/SpaceEngineers/nuget/v3/index.json `
          -n SpaceEngineers `
          -u diemar `
          -p "${{ secrets.AZURE_DEVOPS_NUGET_TOKEN }}" `
          --store-password-in-clear-text
        
        # Restore all projects (including MSF dependencies, but we won't build MSF)
        dotnet restore LinearSolver/LinearSolver.csproj
        dotnet restore LinearSolver.Custom/LinearSolver.Custom.csproj
        dotnet restore LinearSolver.Custom.GoalProgramming/LinearSolver.Custom.GoalProgramming.csproj
        dotnet restore LinearSolver.MSF/LinearSolver.MSF.csproj
        dotnet restore RCS/RCS.csproj
        dotnet restore RCS.MSF/RCS.MSF.csproj
        dotnet restore RCS.Test/RCS.Test.csproj
    
    - name: Build solution (Release)
      run: |
        # Build only the projects we need (skip LinearSolver.MSF which has external dependencies)
        dotnet build LinearSolver/LinearSolver.csproj -c Release --no-restore
        dotnet build LinearSolver.Custom/LinearSolver.Custom.csproj -c Release --no-restore
        dotnet build LinearSolver.Custom.GoalProgramming/LinearSolver.Custom.GoalProgramming.csproj -c Release --no-restore
        dotnet build RCS/RCS.csproj -c Release --no-restore
        dotnet build RCS.Test/RCS.Test.csproj -c Release --no-restore
    
    - name: Run tests
      run: dotnet test RCS.Test/RCS.Test.csproj -c Release --no-build --verbosity normal
    
    - name: Pack NuGet packages
      run: |
        dotnet pack LinearSolver/LinearSolver.csproj -c Release --no-build -o ./nupkg
        dotnet pack LinearSolver.Custom/LinearSolver.Custom.csproj -c Release --no-build -o ./nupkg
        dotnet pack RCS/RCS.csproj -c Release --no-build -o ./nupkg
    
    - name: Publish to Azure DevOps Feed
      run: |
        foreach ($nupkg in Get-ChildItem ./nupkg -Filter "*.nupkg") {
          dotnet nuget push $nupkg.FullName `
            -s SpaceEngineers `
            --skip-duplicate
        }
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./nupkg
        retention-days: 30

  notify:
    runs-on: ubuntu-latest
    needs: build-test-publish
    if: always()
    
    steps:
    - name: Publish result
      run: |
        if [ "${{ needs.build-test-publish.result }}" = "success" ]; then
          echo "✅ NuGet packages published successfully"
        else
          echo "❌ Publishing failed"
        fi
